Очевидно, что синхронная обработка запросов ко внешним API выглядит рискованным - из-за отсутствия или долгого ответа от одной страховой компании "висит" или падает весь запрос. Текущая концепция взаимодействия может приводить к частичной рассогласованности данных между сервисами core-app и ins-comp-settlement. С учетом расширения по всей РФ вероятность коллизии может возрасти.
Один из вариантов решения проблем добавить к aggregator собственную БД типо PG, сохранять данные страховых компаний, опрашивая их с согласованным интервалом. Ответ для внутренних микросервисов формировать на основе данных БД, а чтобы снизить нагрузку и задержки, можно воспользоваться различным вариантом кеширования, используя тот же Redis. Тогда в принципе ничего не придется менять в концепции взаимодействия.
Также можно "улучшить" взаимодействие между core-app и settlement. И хотя особых проблем и рисков не наблюдается, тем не менее ночной bulk запрос может сильно нагружать сервис core-app и в перспективе работы по всем часовым поясам РФ приводить к деградации отклика приложения для пользоватей. Переход на EDA решит эти проблемы. Плюс позволит увеличить частоту взаиморасчётов при необходимости без нагрузки других сервисов. transcation outbox в части событий со страховками - да.
Второй вариант использовать "модный" EDA с топиком/очередью. Последний на базе RabbitMQ предпочтительнее, тк можно использовать методы Push для доставки сообщений, что снижает вероятность неконсистетности данных и проще реализовать. Но заглядывая немного вперед, мы знаем о планах ОСАГО, где пиковое количество пользователей достаточно высоко. Чтобы подойти единообразно сразу выберем вариант с Kafka, чтобы исключить ненужные переделки в будущем. Нужен ли transcation outbox в текущем сценарии? Это было бы необходимо, если сервис aggregator выдал бы данные по компаниям напрямую в UI по Rest или еще как-то. Но в данном случае такой потребности нет, поэтому можно добавить только передачу сообщений в топик от страховых компаний.
 
